{% extends 'dashboard/layout.html' %}

{% set active_page = 'leaderboard' %}

{% block dashboard_title %}Leaderboard{% endblock %}

{% block dashboard_content %}
<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="leaderboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="true">
            Most Active Users
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="popular-tab" data-bs-toggle="tab" data-bs-target="#popular" type="button" role="tab" aria-controls="popular" aria-selected="false">
            Most Popular Users
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="achievements-tab" data-bs-toggle="tab" data-bs-target="#achievements" type="button" role="tab" aria-controls="achievements" aria-selected="false">
            Achievement Leaders
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="leaderboardTabContent">
    <!-- Most Active Users Tab -->
    <div class="tab-pane fade show active" id="activities" role="tabpanel" aria-labelledby="activities-tab">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Most Active Users</h6>
            </div>
            <div class="card-body">
                {% if active_users %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Total Duration (minutes)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user, duration in active_users %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.email }}" alt="Avatar" class="avatar-sm me-2">
                                        <span>{{ user.email }}</span>
                                    </div>
                                </td>
                                <td>{{ "%.1f"|format(duration or 0) }}</td>
                                <td>
                                    {% if current_user.id != user.id %}
                                        {% if current_user.is_following(user) %}
                                        <button class="btn btn-sm btn-outline-danger unfollow-btn" data-user-id="{{ user.id }}">
                                            <i class="fas fa-user-minus"></i> Unfollow
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-primary follow-btn" data-user-id="{{ user.id }}">
                                            <i class="fas fa-user-plus"></i> Follow
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">You</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p>No activity data available yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Most Popular Users Tab -->
    <div class="tab-pane fade" id="popular" role="tabpanel" aria-labelledby="popular-tab">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Most Popular Users</h6>
            </div>
            <div class="card-body">
                {% if popular_users %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Followers</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user, count in popular_users %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.email }}" alt="Avatar" class="avatar-sm me-2">
                                        <span>{{ user.email }}</span>
                                    </div>
                                </td>
                                <td>{{ count }}</td>
                                <td>
                                    {% if current_user.id != user.id %}
                                        {% if current_user.is_following(user) %}
                                        <button class="btn btn-sm btn-outline-danger unfollow-btn" data-user-id="{{ user.id }}">
                                            <i class="fas fa-user-minus"></i> Unfollow
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-primary follow-btn" data-user-id="{{ user.id }}">
                                            <i class="fas fa-user-plus"></i> Follow
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">You</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p>No follower data available yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Achievement Leaders Tab -->
    <div class="tab-pane fade" id="achievements" role="tabpanel" aria-labelledby="achievements-tab">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Achievement Leaders</h6>
            </div>
            <div class="card-body">
                {% if top_users_by_achievements %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Achievements</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user, count in top_users_by_achievements %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.email }}" alt="Avatar" class="avatar-sm me-2">
                                        <span>{{ user.email }}</span>
                                    </div>
                                </td>
                                <td>{{ count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p>No achievement data available yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activity Type Distribution -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Community Activity Distribution</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie">
                    <canvas id="activityDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up follow/unfollow buttons
        setupFollowButtons();
        
        // Load achievement leaders
        loadAchievementLeaders();
        
        // Set up activity distribution chart
        setupActivityDistributionChart();
    });
    
    function setupFollowButtons() {
        // Follow buttons
        document.querySelectorAll('.follow-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.getAttribute('data-user-id');
                try {
                    const response = await fetch(`/api/follow/${userId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        // Change button to unfollow
                        this.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-outline-danger');
                        this.classList.remove('follow-btn');
                        this.classList.add('unfollow-btn');
                    } else {
                        const error = await response.json();
                        alert(`Error following user: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error following user:', error);
                    alert('Error following user. Please try again.');
                }
            });
        });
        
        // Unfollow buttons
        document.querySelectorAll('.unfollow-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.getAttribute('data-user-id');
                try {
                    const response = await fetch(`/api/unfollow/${userId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        // Change button to follow
                        this.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-outline-primary');
                        this.classList.remove('unfollow-btn');
                        this.classList.add('follow-btn');
                    } else {
                        const error = await response.json();
                        alert(`Error unfollowing user: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error unfollowing user:', error);
                    alert('Error unfollowing user. Please try again.');
                }
            });
        });
    }
    
    async function loadAchievementLeaders() {
        // In a real app, we would fetch this from an API endpoint
        // For now, using placeholder data
        const achievementLeadersHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Achievements</th>
                            <th>Last Achievement</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user1@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user1@example.com</span>
                                </div>
                            </td>
                            <td>8</td>
                            <td>Marathon Runner</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user2@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user2@example.com</span>
                                </div>
                            </td>
                            <td>7</td>
                            <td>Century Rider</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user3@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user3@example.com</span>
                                </div>
                            </td>
                            <td>5</td>
                            <td>Early Bird</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('achievement-leaders').innerHTML = achievementLeadersHtml;
    }
    
    function setupActivityDistributionChart() {
        const ctx = document.getElementById('activityDistributionChart').getContext('2d');
        
        // Sample data for activity distribution
        const data = {
            labels: ['Running', 'Walking', 'Cycling', 'Swimming', 'Weight Training', 'Yoga'],
            datasets: [{
                data: [30, 15, 20, 10, 15, 10],
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                ],
                hoverBackgroundColor: [
                    '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#60616f'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)"
            }]
        };
        
        new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const label = tooltipItem.label || '';
                                const value = tooltipItem.raw || 0;
                                const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${percentage}%`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }
</script>
{% endblock %}