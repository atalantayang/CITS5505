{% extends 'dashboard/layout.html' %}

{% set active_page = 'leaderboard' %}

{% block dashboard_title %}Leaderboard{% endblock %}

{% block dashboard_content %}
<div class="row">
    <div class="col-md-6">
        <div class="card leaderboard-card shadow mb-4">
            <div class="card-header">
                <h4 class="mb-0">üèÉ Most Active Users</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Total Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in most_active %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.email }}" class="avatar-sm me-2">
                                {{ user.id }}
                            </td>
                            <td>
                                {% set seconds = user.total_duration.total_seconds()|int %}
                                {% set hours = seconds // 3600 %}
                                {% set minutes = (seconds % 3600) // 60 %}
                                {% set seconds = seconds % 60 %}
                                {{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card leaderboard-card shadow mb-4">
            <div class="card-header">
                <h4 class="mb-0">üèÖ Achievement Leaders</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Achievements</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in achievement_leaders %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.email }}" class="avatar-sm me-2">
                                {{ user.id }}
                            </td>
                            <td>{{ user.user_achievements|length }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up follow/unfollow buttons
        setupFollowButtons();
        
        // Load achievement leaders
        loadAchievementLeaders();
        
        // Set up activity distribution chart
        setupActivityDistributionChart();
    });
    
    function setupFollowButtons() {
        // Follow buttons
        document.querySelectorAll('.follow-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.getAttribute('data-user-id');
                try {
                    const response = await fetch(`/api/follow/${userId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        // Change button to unfollow
                        this.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-outline-danger');
                        this.classList.remove('follow-btn');
                        this.classList.add('unfollow-btn');
                    } else {
                        const error = await response.json();
                        alert(`Error following user: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error following user:', error);
                    alert('Error following user. Please try again.');
                }
            });
        });
        
        // Unfollow buttons
        document.querySelectorAll('.unfollow-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const userId = this.getAttribute('data-user-id');
                try {
                    const response = await fetch(`/api/unfollow/${userId}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        // Change button to follow
                        this.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-outline-primary');
                        this.classList.remove('unfollow-btn');
                        this.classList.add('follow-btn');
                    } else {
                        const error = await response.json();
                        alert(`Error unfollowing user: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error unfollowing user:', error);
                    alert('Error unfollowing user. Please try again.');
                }
            });
        });
    }
    
    async function loadAchievementLeaders() {
        // In a real app, we would fetch this from an API endpoint
        // For now, using placeholder data
        const achievementLeadersHtml = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Achievements</th>
                            <th>Last Achievement</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user1@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user1@example.com</span>
                                </div>
                            </td>
                            <td>8</td>
                            <td>Marathon Runner</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user2@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user2@example.com</span>
                                </div>
                            </td>
                            <td>7</td>
                            <td>Century Rider</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="https://api.dicebear.com/7.x/initials/svg?seed=user3@example.com" alt="Avatar" class="avatar-sm me-2">
                                    <span>user3@example.com</span>
                                </div>
                            </td>
                            <td>5</td>
                            <td>Early Bird</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('achievement-leaders').innerHTML = achievementLeadersHtml;
    }
    
    function setupActivityDistributionChart() {
        const ctx = document.getElementById('activityDistributionChart').getContext('2d');
        
        // Sample data for activity distribution
        const data = {
            labels: ['Running', 'Walking', 'Cycling', 'Swimming', 'Weight Training', 'Yoga'],
            datasets: [{
                data: [30, 15, 20, 10, 15, 10],
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                ],
                hoverBackgroundColor: [
                    '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#60616f'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)"
            }]
        };
        
        new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const label = tooltipItem.label || '';
                                const value = tooltipItem.raw || 0;
                                const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${percentage}%`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }
</script>
{% endblock %}